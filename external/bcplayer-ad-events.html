
<!DOCTYPE html>
<html>
<head>
  <title>Brightcove Player - IMA3 Advertising</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="/simon/brightcodes.css" type="text/css" media="screen" charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
</head>
<body>
  <span class="meta">Brightcove Player</span>&nbsp;<span class="meta">Advertising</span>&nbsp;
  <h1>Brightcove Player - IMA3 Advertising</h1>
  <video
  id="bcplayer"
  width="640"
  height="360"
  data-account="4360108595001"
  data-player="default"
  data-embed="default"
  data-video-id="4714109738001"
  class="video-js" controls></video>
  <td>
    <fieldset style="width: 190px;height: 360px;">
     <legend>Results</legend>
     <div id="results" style="height: 360px;width: 380px;overflow: scroll;font-size: small;"></div>
   </fieldset>
 </td>
 <script src="//players.brightcove.net/4360108595001/default_default/index.min.js"></script>
 <script src="//players.brightcove.net/videojs-ima3/2/videojs.ima3.js"></script>
 <link href="//players.brightcove.net/videojs-ima3/2/videojs.ima3.min.css" rel="stylesheet">

 <script type="text/JavaScript">
  Object.size = function(obj) {
    var size = 0, key;
    for (key in obj) {
      if (obj.hasOwnProperty(key)) size++;
    }
    return size;
  };

  var brightcovePlayer = videojs(Object.keys(videojs.getPlayers())[0]);

  brightcovePlayer.ready(function(){


    var options = {};
    options.serverUrl = "https://pubads.g.doubleclick.net/gampad/ads?sz=640x480&iu=/124319096/external/single_ad_samples&ciu_szs=300x250&impl=s&gdfp_req=1&env=vp&output=vast&unviewed_position_start=1&cust_params=deployment%3Ddevsite%26sample_ct%3Dskippablelinear&correlator="
    options.timeout = 5000;
    options.requestMode= "onload";
    options.vpaidMode = "INSECURE";
    adTechOverride = /adTechOrder=([^&]*)/.exec(window.location.search);
    if (adTechOverride) {
      options.adTechOrder = adTechOverride[1].split(',');
    }
    else{
      options.adTechOrder = ["html5","flash"];
    }
    options.debug = true;

    if (typeof brightcovePlayer.ima3 == 'function'){
      brightcovePlayer.ima3(options);
      results.innerHTML += "BC IMA3 PLUGIN: " + brightcovePlayer.ima3.VERSION + "<br/>";
      if(brightcovePlayer.el().classList.contains('vjs-ima3-html5')){
        results.innerHTML += "BC IMA3 AdTech: HTML5 <br/>";
      }
      else if (brightcovePlayer.el().classList.contains('vjs-ima3-flash')) {
        results.innerHTML += "BC IMA3 AdTech: FLASH <br/>";
      }

      var eventMap = brightcovePlayer.ima3.settings.eventMap;
      var length = Object.size(eventMap);
      var adEvent = Object.keys(eventMap);
      // contrib-ads events
      brightcovePlayer.on(['loadedmetadata','loadeddata','readyforpreroll','adsready','adstart','adend','contentupdate','cotentplayback','adtimeout','adscanceled','adserror','contentended',',mediachange'],function(event){
        results.innerHTML += "BC IMA3 EVENT: " + event.type + "<br/>";
      });

      // general ima3 events
      brightcovePlayer.on(['ima3-resumed','ima3-paused','ima3-ad-error','ima3-started','ima3-ready','ima3-ads-manager-loaded'],function(event){
        results.innerHTML += "BC IMA3 EVENT: " + event.type + "<br/>";
      });

      // universal ad events
      for(x=0;x<length;x++){
        brightcovePlayer.on(eventMap[adEvent[x]],function(event){
          results.innerHTML += "BC IMA3 EVENT: " + event.type + "<br/>";
        });
      }
    }

// rough logic for video view
var loadstart,playing,view,impress,adend,adstart;

brightcovePlayer.on('loadstart',function(){
  loadstart = brightcovePlayer.bcAnalytics.client.history_.first('loadstart');
  playing = brightcovePlayer.bcAnalytics.client.history_.first('play');
  impress = (loadstart || play) && !brightcovePlayer.bcAnalytics.client.timeOfImpression;
  if(impress){
    results.innerHTML += "BC EVENT (in test): impression <br/>";
  }
});

brightcovePlayer.on('adstart',function(){
  adstart = brightcovePlayer.bcAnalytics.client.history_.first('adstart');
});

brightcovePlayer.on('adend',function(){
  adend = brightcovePlayer.bcAnalytics.client.history_.first('adend');
});

brightcovePlayer.on('playing',function(){
  playing = brightcovePlayer.bcAnalytics.client.history_.first('playing');
  view = loadstart && playing && !brightcovePlayer.bcAnalytics.client.timeOfView;
  if(view && adend){
    results.innerHTML += "BC EVENT (in test): view <br/>";
  }
});

});
</script>
</body>
</html>
